# =====================================================
# CONFIGURACIÓN POSTGRESQL OPTIMIZADA PARA PRODUCCIÓN
# HYR Constructora & Soldadura - Sistema Empresarial
# =====================================================
#
# Este archivo contiene configuraciones optimizadas para PostgreSQL
# en un servidor de producción para el sistema HYR.
#
# INSTRUCCIONES:
# 1. Hacer backup del postgresql.conf original
# 2. Aplicar estas configuraciones según los recursos del servidor
# 3. Reiniciar PostgreSQL después de aplicar cambios
# =====================================================

# =====================================================
# CONEXIONES Y AUTENTICACIÓN
# =====================================================

# Número máximo de conexiones simultáneas
# Ajustar según RAM disponible (típicamente RAM_GB * 25-50)
max_connections = 200

# Conexiones reservadas para superusuarios
superuser_reserved_connections = 3

# Tiempo límite para conexiones inactivas (en minutos)
idle_in_transaction_session_timeout = 30min

# =====================================================
# MEMORIA Y BUFFERS
# =====================================================

# Memoria compartida para buffers (25% de RAM total)
# Para servidor con 4GB RAM: 1GB
# Para servidor con 8GB RAM: 2GB
# Para servidor con 16GB RAM: 4GB
shared_buffers = 1GB

# Memoria de trabajo por operación de ordenamiento/hash
# Configurar según número de conexiones concurrentes
work_mem = 8MB

# Memoria para operaciones de mantenimiento (VACUUM, CREATE INDEX)
maintenance_work_mem = 256MB

# Memoria para buffer de escritura WAL
wal_buffers = 16MB

# Memoria efectiva de cache (50-75% de RAM total)
# PostgreSQL usa esto para estimar costos de consultas
effective_cache_size = 3GB

# =====================================================
# ESCRITURA Y CHECKPOINT
# =====================================================

# Número máximo de archivos WAL (Write-Ahead Logging)
max_wal_size = 2GB
min_wal_size = 512MB

# Configuración de checkpoint para mejor rendimiento
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9

# Buffer para escrituras en background
bgwriter_delay = 50ms
bgwriter_lru_maxpages = 200
bgwriter_lru_multiplier = 4.0

# =====================================================
# LOGGING Y MONITOREO
# =====================================================

# Directorio de logs (ajustar según sistema)
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# Nivel de logging
log_min_messages = warning
log_min_error_statement = error

# Log de consultas lentas (ajustar threshold según necesidades)
log_min_duration_statement = 1000  # Log queries > 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on

# Estadísticas detalladas para optimización
log_statement = 'mod'  # Log INSERT, UPDATE, DELETE, TRUNCATE
log_line_prefix = '%t [%p-%l] %q%u@%d '

# =====================================================
# ESTADÍSTICAS Y AUTOVACUUM
# =====================================================

# Habilitar recolección de estadísticas
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Configuración de autovacuum optimizada para sistema transaccional
autovacuum = on
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# Configuraciones específicas para tablas de alta actividad
# (Estas se aplicarán via ALTER TABLE después de la instalación)
# time_entries: autovacuum_vacuum_scale_factor = 0.05
# expenses: autovacuum_vacuum_scale_factor = 0.05
# audit_events: autovacuum_vacuum_scale_factor = 0.02

# =====================================================
# OPTIMIZACIÓN DE CONSULTAS
# =====================================================

# Configuraciones del query planner
default_statistics_target = 100
constraint_exclusion = partition
cursor_tuple_fraction = 0.1

# Configuraciones para JOINs
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on
enable_indexscan = on
enable_indexonlyscan = on

# Costos relativos para diferentes tipos de operaciones
seq_page_cost = 1.0
random_page_cost = 2.0  # Para SSD usar 1.1-1.3, para HDD usar 2.0-4.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# =====================================================
# CONFIGURACIONES DE SEGURIDAD
# =====================================================

# Configuraciones SSL (si se usa HTTPS)
ssl = off  # Cambiar a 'on' si se requiere SSL
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'

# Configuraciones de conexión segura
password_encryption = scram-sha-256
row_security = on

# Timeout de autenticación
authentication_timeout = 60s

# =====================================================
# CONFIGURACIONES ESPECÍFICAS PARA HYR SYSTEM
# =====================================================

# Timezone para Colombia
timezone = 'America/Bogota'
log_timezone = 'America/Bogota'

# Configuración de charset
lc_messages = 'en_US.UTF-8'
lc_monetary = 'es_CO.UTF-8'
lc_numeric = 'es_CO.UTF-8'
lc_time = 'es_CO.UTF-8'
default_text_search_config = 'pg_catalog.spanish'

# =====================================================
# CONFIGURACIONES AVANZADAS
# =====================================================

# Configuraciones para mejores escrituras concurrentes
wal_level = replica
synchronous_commit = on
wal_sync_method = fdatasync
full_page_writes = on

# Configuraciones de procesos en background
max_worker_processes = 8
max_parallel_workers = 4
max_parallel_workers_per_gather = 2
max_parallel_maintenance_workers = 2

# Configuraciones de extensiones
shared_preload_libraries = 'pg_stat_statements'

# =====================================================
# NOTAS PARA ADMINISTRADORES
# =====================================================

# MONITOREO RECOMENDADO:
# 1. Usar pg_stat_statements para identificar consultas lentas
# 2. Monitorear pg_stat_database para estadísticas de BD
# 3. Usar pg_stat_user_tables para estadísticas de tablas
# 4. Monitorear conexiones activas con pg_stat_activity

# COMANDOS ÚTILES PARA MONITOREO:
# SELECT query, calls, total_time, mean_time FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;
# SELECT schemaname, tablename, n_tup_ins, n_tup_upd, n_tup_del FROM pg_stat_user_tables;
# SELECT datname, numbackends, xact_commit, xact_rollback FROM pg_stat_database WHERE datname = 'hyr_construction';

# BACKUP RECOMENDADO:
# pg_dump -h localhost -U hyr_user -d hyr_construction -f backup-$(date +%Y%m%d).sql
# Configurar cron job para backups automáticos diarios

# MANTENIMIENTO REGULAR:
# VACUUM ANALYZE; -- Ejecutar semanalmente
# REINDEX DATABASE hyr_construction; -- Ejecutar mensualmente
# Monitorear fragmentación de índices

# =====================================================
# CONFIGURACIONES POR TAMAÑO DE SERVIDOR
# =====================================================

# SERVIDOR PEQUEÑO (2GB RAM, 2 CPU cores):
# shared_buffers = 512MB
# effective_cache_size = 1536MB
# work_mem = 4MB
# maintenance_work_mem = 128MB
# max_connections = 100
# max_worker_processes = 4

# SERVIDOR MEDIANO (4GB RAM, 4 CPU cores):
# shared_buffers = 1GB
# effective_cache_size = 3GB
# work_mem = 8MB
# maintenance_work_mem = 256MB
# max_connections = 200
# max_worker_processes = 8

# SERVIDOR GRANDE (8GB RAM, 8 CPU cores):
# shared_buffers = 2GB
# effective_cache_size = 6GB
# work_mem = 16MB
# maintenance_work_mem = 512MB
# max_connections = 300
# max_worker_processes = 16

# =====================================================
# APLICAR CONFIGURACIONES ESPECÍFICAS POR TABLA
# =====================================================

# Después de instalar la BD, ejecutar estos comandos para optimizar
# tablas de alta transaccionalidad:

# ALTER TABLE time_entries SET (autovacuum_vacuum_scale_factor = 0.05);
# ALTER TABLE expenses SET (autovacuum_vacuum_scale_factor = 0.05);
# ALTER TABLE audit_events SET (autovacuum_vacuum_scale_factor = 0.02);
# ALTER TABLE payroll_details SET (autovacuum_analyze_scale_factor = 0.02);

# Configurar estadísticas más detalladas para columnas de búsqueda frecuente:
# ALTER TABLE projects ALTER COLUMN budget_total SET STATISTICS 1000;
# ALTER TABLE expenses ALTER COLUMN amount SET STATISTICS 1000;
# ALTER TABLE time_entries ALTER COLUMN work_date SET STATISTICS 1000;
# ALTER TABLE personnel ALTER COLUMN status SET STATISTICS 1000;